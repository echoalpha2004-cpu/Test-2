<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AR Clothing Prototype — Demo</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#111;--accent:#ffd166}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    .app{height:100%;display:flex;flex-direction:column;background:var(--bg);color:#eee}
    #view{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}
    video#camera{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
    canvas#videoCanvas{position:absolute;top:0;left:0;width:100%;height:100%;}

    img#overlay{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);max-width:70%;opacity:0.95;pointer-events:none}

    .topbar{display:flex;gap:8px;padding:8px;background:linear-gradient(180deg,rgba(0,0,0,0.4),transparent);position:absolute;top:0;left:0;right:0;z-index:20}
    button{background:#222;border:1px solid #333;color:#fff;padding:8px 10px;border-radius:6px}
    .infoPanel{position:absolute;right:8px;bottom:8px;background:var(--panel);padding:12px;border-radius:10px;max-width:46%;z-index:20}
    .hint{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px;font-size:12px}
    .modeBadge{position:absolute;left:50%;top:10px;transform:translateX(-50%);background:#111;padding:6px 12px;border-radius:999px;border:1px solid #222;z-index:20}
    .portraitInfo{display:none;padding:12px}
    @media (orientation: portrait) {
      .portraitInfo{display:block;background:var(--panel);height:100%;overflow:auto}
      #view{display:none}
    }
    footer{padding:8px;text-align:center;font-size:12px;background:linear-gradient(0deg,rgba(0,0,0,0.5),transparent)}
    .metaLabel{color:#ccc;font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <div id="view">
      <video id="camera" autoplay playsinline></video>
      <canvas id="videoCanvas"></canvas>
      <img id="overlay" src="" alt="overlay" style="display:none" />

      <div class="topbar">
        <button id="scanBtn">Scan QR</button>
        <button id="toggleMirror">Toggle Mirror</button>
        <div style="flex:1"></div>
        <div id="status">No item scanned</div>
      </div>

      <div class="modeBadge" id="modeBadge">Mode: <span id="modeText">AR try-on</span></div>

      <div class="infoPanel" id="infoPanel" style="display:none">
        <div><strong id="itemTitle"></strong></div>
        <div class="metaLabel" id="itemMeta"></div>
        <div style="margin-top:8px;">Recommendations:</div>
        <div id="recs"></div>
      </div>

      <div class="hint">Tip: Hold horizontally for try-on, vertically for item info</div>
    </div>

    <div class="portraitInfo" id="portraitInfo" style="display:none">
      <h2 id="pTitle">No item scanned</h2>
      <p id="pMeta">Scan an item's QR code while in landscape to load metadata, then rotate to portrait to inspect details.</p>
      <div id="pRecs"></div>
    </div>

    <footer>Prototype — student build. Serve via HTTPS for camera access.</footer>
  </div>

  <!-- jsQR (QR code library) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.min.js"></script>

  <script>
    const ITEM_DB = {
      "item:shirt:001":{
        title:"Navy Vintage Tee",
        size:"M",
        brand:"LabelCo",
        info:"Vintage cut, 100% cotton. Machine wash cold.",
        overlay:"https://via.placeholder.com/300x400?text=T-Shirt",
        recs:["khaki_chinos","white_sneakers"]
      },
      "item:jacket:002":{
        title:"Utility Jacket",
        size:"L",
        brand:"FieldWorks",
        info:"Lightweight, water-resistant. Recommend layering.",
        overlay:"https://via.placeholder.com/300x400?text=Jacket",
        recs:["black_boots","denim_jeans"]
      }
    };
    const RECS_FRIENDLY = {
      "khaki_chinos":"Khaki chinos",
      "white_sneakers":"White sneakers",
      "black_boots":"Black boots",
      "denim_jeans":"Denim jeans"
    };

    const video=document.getElementById('camera');
    const canvas=document.getElementById('videoCanvas');
    const ctx=canvas.getContext('2d');
    const overlayImg=document.getElementById('overlay');
    const status=document.getElementById('status');
    const infoPanel=document.getElementById('infoPanel');
    const itemTitle=document.getElementById('itemTitle');
    const itemMeta=document.getElementById('itemMeta');
    const recs=document.getElementById('recs');
    const portraitInfo=document.getElementById('portraitInfo');
    const pTitle=document.getElementById('pTitle');
    const pMeta=document.getElementById('pMeta');
    const pRecs=document.getElementById('pRecs');
    const modeText=document.getElementById('modeText');

    let currentItem=null;
    let scanning=false;

    async function startCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
        video.srcObject=stream;
        await video.play();
      }catch(e){
        alert('Camera access denied or unavailable. Please allow camera and use HTTPS.');
      }
    }

    function scanFrameForQR(){
      if(video.readyState!==video.HAVE_ENOUGH_DATA)return null;
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:"attemptBoth"});
      if(code){
        // Draw rectangle around detected QR
        ctx.beginPath();
        ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
        ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
        ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
        ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
        ctx.closePath();
        ctx.lineWidth=4;
        ctx.strokeStyle="red";
        ctx.stroke();
      }
      return code?code.data:null;
    }

    document.getElementById('scanBtn').addEventListener('click',()=>{
      if(scanning){scanning=false;document.getElementById('scanBtn').textContent='Scan QR';return;}
      scanning=true;document.getElementById('scanBtn').textContent='Stop scanning';
      const loop=()=>{
        if(!scanning)return;
        const q=scanFrameForQR();
        if(q){
          scanning=false;
          document.getElementById('scanBtn').textContent='Scan QR';
          handleScan(q);
        }else{
          requestAnimationFrame(loop);
        }
      };
      loop();
    });

    function handleScan(payload){
      status.textContent='Scanned: '+payload;
      const item=ITEM_DB[payload];
      if(!item){
        alert('Unknown QR: '+payload);
        return;
      }
      currentItem=item;
      overlayImg.src=item.overlay;
      overlayImg.style.display='block';
      itemTitle.textContent=item.title;
      itemMeta.textContent=item.brand+' • '+item.size+'\n'+item.info;
      recs.innerHTML='';
      item.recs.forEach(rid=>{
        const d=document.createElement('div');
        d.textContent=RECS_FRIENDLY[rid]||rid;
        recs.appendChild(d);
      });
      infoPanel.style.display='block';
      pTitle.textContent=item.title;
      pMeta.textContent=item.brand+' — '+item.size+'\n'+item.info;
      pRecs.innerHTML='<strong>Recommendations</strong><br>'+item.recs.map(r=>RECS_FRIENDLY[r]||r).join(', ');
    }

    function updateMode(){
      const isPortrait=window.matchMedia('(orientation: portrait)').matches;
      if(isPortrait){
        modeText.textContent='Info';
        document.getElementById('view').style.display='none';
        portraitInfo.style.display='block';
      }else{
        modeText.textContent='AR try-on';
        document.getElementById('view').style.display='flex';
        portraitInfo.style.display='none';
      }
    }
    window.addEventListener('orientationchange',updateMode);
    window.addEventListener('resize',updateMode);

    startCamera().then(updateMode);
  </script>
</body>
</html>
